<div class="flex flex-col flex-auto min-w-0 sm:overflow-hidden bg-card dark:bg-transparent p-4">
  <div class="flex justify-between">
    <div class="absolute inset-x-0 bottom-0" *ngIf="isLoading">
      <mat-progress-bar [mode]="'indeterminate'"></mat-progress-bar>
    </div>
    <div class="text-3xl font-bold tracking-tight">Грузы</div>
    <div class="flex justify-end gap-2">
      <button class="fuse-mat-button-large dark" mat-flat-button [color]="'primary'" (click)="showFilter = !showFilter">
        <mat-icon>search</mat-icon>
        Поиск
      </button>
      <button (click)="createOrderModal()" class="fuse-mat-button-large dark" mat-flat-button [color]="'primary'">
        <mat-icon>add</mat-icon>
        Разместить груз
      </button>
    </div>
  </div>

  <div class="filter flex items-center gap-2" [@showHideFilter]="showFilter ? 'show' : 'hide'">
    <div>
      <mat-form-field class="flex-auto">
        <mat-label>Груз ID</mat-label>
        <input type="number" matInput [(ngModel)]="filter.orderId">
      </mat-form-field>
    </div>

    <div>
      <mat-form-field class="flex-auto">
        <mat-label>Статус</mat-label>
        <mat-select [(ngModel)]="filter.statusId">
          <mat-option *ngFor="let status of statuses" [value]="status.id">{{status.name}}</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
    <div>
      <mat-form-field class="flex-auto">
        <mat-label>Откуда</mat-label>
        <input type="text" matInput [(ngModel)]="filter.loadingLocation">
      </mat-form-field>
    </div>
    <div>
      <mat-form-field class="flex-auto">
        <mat-label>Куда</mat-label>
        <input type="text" matInput [(ngModel)]="filter.deliveryLocation">
      </mat-form-field>
    </div>

    <button (click)="resetSearch()" class="fuse-mat-button-large dark" mat-flat-button [color]="'primary'">
      <mat-icon>refresh</mat-icon>
    </button>
    <button (click)="applyFilter()" class="fuse-mat-button-large dark" mat-flat-button [color]="'primary'">
      <mat-icon>search</mat-icon>
    </button>
  </div>

  <div class="my-6" *ngIf="!isLoading">
    <mat-table matSort [dataSource]="dataSource" class="overflow-auto" >
      <ng-container matColumnDef="index">
        <mat-header-cell class="font-extrabold index-column " *matHeaderCellDef> No </mat-header-cell>
        <mat-cell class="index-column relative" *matCellDef="let row; let i=index">
          <div>
            {{ i + 1 }}
            <div
              class="absolute inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-green-700 border-1 border-white rounded-full top-0 right-0 dark:border-gray-900"
              *ngIf="row.driverOffers.length > 0 && row.cargoStatus.code == 0">
              {{row.driverOffers.length}}</div>
          </div>
        </mat-cell>
      </ng-container>

      <ng-container matColumnDef="id">
        <mat-header-cell class="font-extrabold index-column cursor-pointer flex justify-between" *matHeaderCellDef
          mat-sort-header (click)="sortData('id')">
          ID
          <mat-icon>{{ getSortIcon('id') }}</mat-icon>
        </mat-header-cell>
        <mat-cell class="index-column" *matCellDef="let row"> {{ row?.id }} </mat-cell>
      </ng-container>

      <ng-container matColumnDef="loadingLocation">
        <mat-header-cell class="cursor-pointer flex justify-between" *matHeaderCellDef mat-sort-header
          (click)="sortData('loadingLocation')">
          Откуда
          <mat-icon>{{ getSortIcon('loadingLocation') }}</mat-icon>
        </mat-header-cell>
        <mat-cell *matCellDef="let row"> {{row?.loadingLocation}} </mat-cell>
      </ng-container>

      <ng-container matColumnDef="deliveryLocation">
        <mat-header-cell class="cursor-pointer flex justify-between" *matHeaderCellDef
          (click)="sortData('deliveryLocation')">
          Куда
          <mat-icon>{{ getSortIcon('deliveryLocation') }}</mat-icon>
        </mat-header-cell>
        <mat-cell *matCellDef="let row"> {{row?.deliveryLocation}} </mat-cell>
      </ng-container>

      <ng-container matColumnDef="cargoStatus">
        <mat-header-cell *matHeaderCellDef>
          Статус
          <!-- <mat-icon>{{ getSortIcon('cargoStatus') }}</mat-icon> -->
        </mat-header-cell>
        <mat-cell *matCellDef="let row">
          <div class="status-badge relative" [style.backgroundColor]="row.cargoStatus.color">
            {{row.cargoStatus.name}}
          </div>
        </mat-cell>
      </ng-container>

      <ng-container matColumnDef="sendDate">
        <mat-header-cell class="cursor-pointer flex justify-between" *matHeaderCellDef (click)="sortData('sendDate')">
          Дата погрузки
          <mat-icon>{{ getSortIcon('sendDate') }}</mat-icon>
        </mat-header-cell>
        <mat-cell *matCellDef="let row">
          {{ row.sendDate | date : 'dd.MM.YYYY'}}
        </mat-cell>
      </ng-container>

      <ng-container matColumnDef="offeredPrice">
        <mat-header-cell class="cursor-pointer flex justify-between" *matHeaderCellDef
          (click)="sortData('offeredPrice')">
          Предлагаемая стоимость
          <mat-icon>{{ getSortIcon('offeredPrice') }}</mat-icon>
        </mat-header-cell>
        <mat-cell *matCellDef="let row">
          {{ row.offeredPrice ? row.offeredPrice + ' ' + row.offeredPriceCurrency.name: 'Не указана' }}
        </mat-cell>
      </ng-container>

      <ng-container matColumnDef="isSafe">
        <mat-header-cell *matHeaderCellDef >
          Безопасная сделка
          <!-- <mat-icon>{{ getSortIcon('isSafe') }}</mat-icon> -->
        </mat-header-cell>
        <mat-cell *matCellDef="let row">{{row.isSafe ? 'Да':'Нет'}}</mat-cell>
      </ng-container>

      <ng-container matColumnDef="type_cargo">
        <mat-header-cell *matHeaderCellDef>
          Тип груза
        </mat-header-cell>
        <mat-cell *matCellDef="let row">
          <div class="truncate">{{ row.cargoType.name }}</div>
        </mat-cell>
      </ng-container>

      <ng-container matColumnDef="transport_type">
        <mat-header-cell *matHeaderCellDef>Тип транспорта</mat-header-cell>
        <mat-cell *matCellDef="let row">
          <span *ngIf="row.transportTypes">
            <span *ngFor="let type of row.transportTypes;let i=index">
              {{type.name}} <br>
            </span>
          </span>
        </mat-cell>
      </ng-container>

      <ng-container matColumnDef="volume">
        <mat-header-cell *matHeaderCellDef>Обьём</mat-header-cell>
        <mat-cell *matCellDef="let row">{{ row.volume ? row.volume : 'Не указана' }}</mat-cell>
      </ng-container>

      <ng-container matColumnDef="date_create">
        <mat-header-cell *matHeaderCellDef>Дата создания</mat-header-cell>
        <mat-cell *matCellDef="let row">{{row.createdAt | date : 'dd.MM.YYYY'}}</mat-cell>
      </ng-container>

      <mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></mat-header-row>
      <mat-row *matRowDef="let row; columns: displayedColumns; let i=index" (click)="showOrderDetails(row)"></mat-row>

    </mat-table>
    <div class="w-full flex justify-center p-2 border" *ngIf="!isLoading && !dataSource?.length">
      Данные отсутствуют в таблице
    </div>
    <div class="flex justify-end">
      <app-pagination [totalPagesCount]="totalPagesCount" [size]="size" [currentPage]="currentPage"
        (paginationEvent)="onPaginationEvent($event)">
      </app-pagination>
    </div>
  </div>
  <div class="w-full flex justify-center p-2 border my-6" *ngIf="isLoading">
    <mat-progress-spinner [diameter]="42" [mode]="'indeterminate'"></mat-progress-spinner>
  </div>
</div>